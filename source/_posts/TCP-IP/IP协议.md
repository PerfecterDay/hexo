---
title: IP协议
date: 2019-12-0921:48:26
tags: tcp/ip
category: tcp/ip
---

IP是TCP/IP协议族中最为核心的协议。所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输(见图1-4)。许多刚开始接触TCP/IP的人对IP提供不可靠、无连接的数据报传送服务感到很奇怪，特别是那些具有X.25或SNA背景知识的人。
不可靠(unreliable)的意思是它不能保证IP数据报能成功地到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法:丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供(如TCP)。
无连接(connectionless)这个术语的意思是IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报(先是A，然后是B)，每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。

### IP地址
![IP地址分类](/pics/ip-address.png)
全0和全1的主机号都是无效的。
子网划分：将主机号范围内部分比特作为子网号来划分子网。

#### 特殊IP地址
下图中0表示所有比特全为0；-1表示所有比特全为1；netid/subnetid/hostid代表不全为0或全为1的对应字段；子网号栏为空表示没有子网划分。
![特殊IP地址](/pics/special-ip.png)
表的头两项是特殊的源地址，中间项是特殊换回地址，最后四项是广播地址。

### IP首部
![IP首部](/pics/ip-header.png)
+ 协议版本：目前的协议版本是4，也就是 IPv4
+ 首部长度：4位，单位是4字节，因此IP首部最大长度是 $(2^4-1)*4=60$ 字节。
+ 8位服务类型（TOS）:3位优先权字段（现在已被忽略）+ 4位TOS子字段+1位保留字段（设0）
+ 总长度字段:代表整个IP数据报总长度，16位，因此IP数据报最大度是$2^{16}=65535$字节
+ 标识字段：标识字段唯一地标识主机发送的每一份数据报。通常每发一份报文它的值就会加1
+ 3位标志:
+ 片偏移:
+ TTL(Time to live)生存时间：设置数据报可以经过的最多路由数，一旦经过一个路由，它的值就减1，当为0时，数据报被丢弃
+ 8位协议: 根据它可以识别是哪个协议向IP传送数据.
+ 16位首部校验和:针对IP首部的校验和。先把校验和字段置为0，然后对首部中每个16bit进行二进制反码求和，结果存在校验和字段中。
+ 32位源IP
+ 32位目的IP
+ 任选项：目前包括
    1. 安全和处理限制（用于军事领域）
    2. 记录路径（让每个路由器都记下它的地址）
    3. 时间戳
    4. 宽松的源站选路（为数据指定一系列必须经过的IP地址）
    5. 严格的源站选路（与4类似，但是只能经过这些地址，不能经过其它地址

### IP路由表
IP路由表中的每一项都包含如下信息：
+目的IP地址，可以是一个完整的主机地址，也可以是一个网络地址，由表中的标志字段来指定。主机地址的有一个非0的主机号，而网络地址的主机号为0，用以指定网络中的所有主机。
+下一跳路由的IP地址。
+标志。其中一个标志指明目的IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一跳路由器，还是一个直接相连的接口。
+数据报传输接口

#### IP路由过程
当IP层收到某个接口来的数据报时：
1.如果目的IP地址是本机IP地址之一或者是IP广播地址，那么数据报被送到由IP首部协议字段指定的上层协议模块处理。
2.否则如果IP层没有设置路由功能，则丢弃该数据报。如果设置了路由功能，则按下述过程对数据报进行转发：
1.搜索路由表寻找能与目标IP地址完全匹配的条目（网络号和主机号都匹配），如果找到，则把数据报转发给该表目指定的下一跳路由器或者直接相连的接口。
2.搜索路由表查找能与目的网络号相匹配的表目。这里需要用到子网掩码。
3.搜索路由表寻找标位默认的表目，将数据报转发给该表目指定的下一跳路由或接口。
4.如果上面这些步骤都没有成功，则返回一个“主机不可达”或“网络不可达”的错误。