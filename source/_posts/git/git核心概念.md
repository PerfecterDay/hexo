---
title: git 核心概念
date: 2020-05-15 13:28:10
tags: git
category: git
---

Git 更像是把数据看作是对小型文件系统的一系列快照。 在 Git 中，每当你提交更新或保存项目状态时，它基本上就会对当时的全部文件创建一个快照并保存这个快照的索引。 为了效率，如果文件没有修改，Git 不再重新存储该文件，而是只保留一个链接指向之前存储的文件。 Git 对待 数据更像是一个快照流。
<img src="/pics/git-snapshot.png" alt="">
Git 一次提交大概的数据结构如下图所示：
<img src="/pics/git-commit.png" alt="">

Git 拥有三个阶段：工作区、暂存区（索引）及 Git 目录。
+ 工作区：工作区是对项目的某个版本独立提取出来的内容。 这些从 Git 仓库的压缩数据库中提取出来的文件，放在磁盘上
供你使用或修改。就是相当于从版本库中提取出一个快照到磁盘上以作修改
+ 暂存区是一个文件，保存了下次将要提交的文件列表信息，一般在 Git 仓库目录中。
+ Git 仓库目录是 Git 用来保存项目的元数据和对象数据库的地方。 这是 Git 中最重要的部分，从其它计算机克隆
仓库时，复制的就是这里的数据。


## 重置与检出
Git 的三个工作区间可以想像成三棵树， reset 命令会以特定的顺序重写这三棵树，在你指定以下选项时停止:
1. 移动 HEAD 分支的指向 (若指定了 --soft，则到此停止) 
2. 使索引看起来像 HEAD (若未指定 --hard，则到此停止) 
3. 使工作目录看起来像索引
<img src="/pics/git-reset.png" alt="">

git reset 后边加上文件或目录路径时，reset 将会跳过第一步，并且将它的作用范围限定为指定的文件或文件集合。  
`git reset eb43bf file.txt`: 将提交为 eb43bf 中的 file.txt 文件版本恢复到索引


下面的速查表列出了命令对树的影响。 “HEAD” 一列中的 “REF” 表示该命令移动了 HEAD 指向的分支引 用，而 “HEAD” 则表示只移动了 HEAD 自身。 特别注意 WD Safe? 一列——如果它标记为 NO，那么运行该命 令之前请考虑一下。
<img src="/pics/git-reset-checkout.png" alt="">

## 底层原理
Git 是一个内容寻址文件系统，听起来很酷。但这是什么意思呢? 这意味着，Git 的核心部分是一个简单的键值对数据库(key-value data store)。 你可以向 Git 仓库中插入任意类型的内容，它会返回一个唯一的键，通过该键可以在任意时刻再次取回该内容。

### Blob对象
#### Git 中存入内容
可以通过底层命令`git hash-object`来演示上述效果——该命令可将任意数据保存于`.git/objects`目录 (即对象数据库)，并返回指向该数据对象的唯一的键。`git hash-object`会接受你传给它的东西，而它只会返回可以存储在Git仓库中的唯 一键。 -w 选项会指示该命令不要只返回键，还要将该对象写入数据库中。上述类型的对象我们称之为数据对象(blob object)

#### 查看存入 Git 的内容
1. `git cat-file -p <hash>` 命令从 Git 那里取回数据， -p 选项可指示该命令自动判断内容的类型，并为我们显示大致的内容：   
    `git cat-file -p 257fa7137cae7c6a3bab82d371be6007a491cd1e`  
2. `git cat-file -t <hash>` 命令，可以让Git告诉我们其内部存储的任何对象类型，只要给定该对象 的 SHA-1 值:
    `git cat-file -p 257fa7137cae7c6a3bab82d371be6007a491cd1e`

### 树对象
树对象(tree object)能解决文件名保存的问题，也允许我们将多个文件组织到一起。 Git 以一种类似于 UNIX 文件系统的方式存储内容，但作了些许简化。 所有内容均以树对象和数据对象的形式存储，其中树对象对应了 UNIX 中的目录项，数据对象则大致上对应了 inodes 或文件内容。 一个树对象包含了一条或多条树对象记录(tree entry)，每条记录含有一个指向数据对象或者子树对象的 SHA-1 指针， 以及相应的模式、类型、文件名信息。

`git cat-file -p master^{tree}`: 查看树对象，master^{tree} 语法表示 master 分支上最新的提交所指向的树对象

通常，Git 根据某一时刻暂存区(即 index 区域，下同)所表示的状态创建并记录一个对应的树对象， 如此重复便可依次记录(某个时间段内)一系列的树对象。首先，需要通过暂存一些文件来创建一个暂存区。然后，可以通过 `git write-tree` 命令将暂存区内容写入一个树对象。

### 提交对象
每个tree对象分别代表我们想要跟踪的不同项目快照。 然而问题依旧:若想重用这些快照，你必须记住所有三个 SHA-1 哈希值。 并且，你也完全不知道是谁保存了这些快照，在什么时刻保存的，以及为什么保存这些快照。 而以上这些，正是提交对象(commit object)能为你保存的基 本信息。
可以通过调用 `git commit-tree` 命令创建一个提交对象，为此需要指定一个树对象的 SHA-1 值，以及该提交的父 提交对象(如果有的话) 。
